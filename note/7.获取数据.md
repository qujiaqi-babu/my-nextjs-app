## 如何获取数据

#### API 层

API 是应用程序代码和数据库之间的中间层。几种可能会使用 API 的情况：

- 如果正在使用提供 API 的第三方服务。
- 如果从客户端获取数据，则需要有一个在服务器上运行的 API 层，以避免向客户端暴露数据库机密。

在 Next.js 中，可以使用**路由处理程序**创建 API 端点。

#### 数据库查询

在创建全栈应用程序时，需要编写逻辑来与数据库交互。对于关系数据库，比如 Postgres，可以使用 SQL 或 ORM 来执行此操作。

在某些情况下必须编写数据库查询：

- 创建 API 端点时，需要编写逻辑来与数据库交互。
- 如果正在使用 React Server Components（在服务器上获取数据），则可以跳过 API 层，直接查询数据库，而不必担心向客户端泄露数据库机密。

#### 使用服务器组件获取数据

默认情况下，Next.js 应用程序使用 **React 服务器组件** 。 使用服务器组件获取数据是一种相对较新的方法，使用它们有几个好处：

- 服务器组件支持 promise，为数据获取等异步任务提供更简单的解决方案。可以使用 `async/await `语法，而无需使用 `useEffect`、`useState `或数据获取库。
- 服务器组件在服务器上执行，因此可以在服务器上保留昂贵的数据提取和逻辑，而仅将结果发送给客户端。
- 由于服务器组件在服务器上执行，因此可以直接查询数据库，而无需额外的 API 层。

#### 使用 SQL

使用 Vercel Postgres SDK 和 SQL 编写数据库查询。

- SQL 是查询关系数据库的行业标准（例如，ORM 在后台生成 SQL）。
- 对 SQL 有基本的了解可以帮助理解关系数据库的基础知识，从而将知识应用到其他工具中。
- SQL 功能多样，可获取和操作特定数据。
- Vercel Postgres SDK 提供针对 SQL injections 的保护。

`/app/lib/data.ts：`导入来自 `@vercel/postgres` 的 `sql `函数以查询数据库。

## **注意：**

1. 数据请求无意中互相阻塞，形成了 **请求瀑布** 。
2. 默认情况下，Next.js**会预渲染**路由以提高性能，这称为**静** **态渲染** 。因此任何数据更新都不会反映在应用程序上。

## 请求瀑布

“瀑布”是指依赖于先前请求完成的一系列网络请求。在数据获取的情况下，每个请求只能在前一个请求返回数据后才能开始。
在某些情况下可能需要这种瀑布流，因为希望在发出下一个请求之前满足某个条件。例如，先获取用户的 ID 和个人资料信息，再获取他们的好友列表。

## 并行数据获取

避免瀑布的常用方法是同时并行发起所有数据请求。在 JavaScript 中，可以使用 `Promise.all()`或者 `Promise.allSettled()`函数同时启动所有 promise 。

**缺点：如果一个数据请求比所有其他请求都慢，那么数据请求**的速度仅与最慢的数据获取速度一样快。\*\*\*\*
